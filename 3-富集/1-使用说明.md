# NUMTs富集分析工具使用说明

## 概述
这套工具用于分析NUMTs（核线粒体DNA）在特定基因组区域中的富集情况，通过排列测试（permutation test）来判断观察到的分布是否具有统计学意义。

## 🚀 快速开始（推荐使用）

### 主脚本：`run_enrichment_analysis.sh`
**一键完成完整的富集分析流程**

**用法**:
```bash
./run_enrichment_analysis.sh <输入BED文件> <输出目录> <NUMTs总数> <目标区域NUMTs数> <NUMT平均长度> [脚本目录]
```

**参数说明**:
- `输入BED文件`: 包含目标区域的BED格式文件 (chr, start, end)
- `输出目录`: 结果文件输出目录
- `NUMTs总数`: 整个基因组中NUMTs的总数量
- `目标区域NUMTs数`: 在目标区域中观察到的NUMTs数量  
- `NUMT平均长度`: NUMTs的平均长度 (bp)
- `脚本目录`: Python脚本所在目录 (可选)

**示例**:
```bash
# 基本用法
./run_enrichment_analysis.sh genes.bed ./results 100 15 500

# 指定脚本目录
./run_enrichment_analysis.sh /path/to/regions.bed /path/to/output 50 8 300 /path/to/scripts
```

**输出文件**:
- `converted_regions.tsv`: 转换后的伪参考基因组文件
- `enrichment_result.tsv`: 富集分析结果文件
- `enrichment_analysis.log`: 详细分析日志

## 📋 工具列表

### 1. `1-创建参考伪参考基因组.py`
**功能**: 将人类基因组的24条染色体重新排列成一条连续的"虚拟染色体"，用于后续的富集分析。

**用法**:
```bash
python3 1-创建参考伪参考基因组.py <输入BED文件> [输出文件]
```

**输入文件**: BED格式文件，包含三列：
- 第1列: 染色体名称 (chr1, chr2, ..., chrX, chrY)  
- 第2列: 起始位置
- 第3列: 结束位置

**输出文件**: 默认为`<输入文件名>.convert.noGap.tsv`，或指定的输出文件路径，在原有基础上添加两列：
- `refStart_noChr`: 虚拟连续基因组中的新起始位置
- `refEnd_noChr`: 虚拟连续基因组中的新结束位置

### 2. `2-富集模拟.py`
**功能**: 通过排列测试分析NUMTs在目标区域中的分布是否异常。

**用法**:
```bash
python3 2-富集模拟.py <转换后的文件> <NUMTs总数> <目标区域中的NUMTs数> <NUMT平均长度> <输出标识> [输出目录]
```

**参数说明**:
- `<转换后的文件>`: 第一步生成的`.convert.noGap.tsv`文件
- `<NUMTs总数>`: 整个基因组中NUMTs的总数量
- `<目标区域中的NUMTs数>`: 在感兴趣区域中观察到的NUMTs数量
- `<NUMT平均长度>`: NUMTs的平均长度（bp）
- `<输出标识>`: 用于命名输出文件的标识符
- `[输出目录]`: 输出目录路径（可选）

**输出结果**:
- P值less: 观察值比随机值小的概率
- P值greater: 观察值比随机值大的概率
- 如果P值 < 0.05，说明分布具有统计学意义

### 3. `convert_numts_to_bed.py` （辅助工具）
**功能**: 将NUMTs聚类数据转换为BED格式。

**用法**:
```bash
python3 convert_numts_to_bed.py <NUMTs聚类文件> <输出BED文件>
```

## 完整分析流程示例

### 使用主脚本（推荐）
```bash
# 基本用法 - 分析基因区域中的NUMTs富集
./run_enrichment_analysis.sh genes.bed ./results 100 15 500

# 分析启动子区域中的NUMTs富集
./run_enrichment_analysis.sh promoters.bed ./promoter_analysis 200 25 300
```

### 手动步骤（用于自定义分析）
```bash
# 1. 转换NUMTs数据为BED格式（如果需要）
python3 convert_numts_to_bed.py /path/to/merge.tsv.allCluster.tsv target_regions.bed

# 2. 创建伪参考基因组
python3 1-创建参考伪参考基因组.py target_regions.bed converted.tsv

# 3. 运行富集分析
python3 2-富集模拟.py converted.tsv 100 15 500 analysis_result ./output_dir
```

## 结果解释

- **P值less < 0.05**: 目标区域中的NUMTs显著少于随机分布
- **P值greater < 0.05**: 目标区域中的NUMTs显著多于随机分布  
- **两个P值都 > 0.05**: NUMTs分布与随机分布无显著差异

## 技术说明

1. **染色体长度**: 基于GRCh38基因组版本的染色体累积长度
2. **模拟次数**: 默认1000次排列测试
3. **依赖**: 可使用pybedtools（推荐）或纯pandas实现
4. **随机采样**: 从整个核基因组范围内随机采样

## 故障排除

1. **模块缺失**: 如果提示pybedtools未安装，脚本会自动切换到pandas实现
2. **内存不足**: 对于大型数据集，可以减少模拟次数
3. **文件格式**: 确保输入的BED文件使用制表符分隔

## 文件清单

生成的文件包括：
- `test_genes.bed`: 测试用的基因区域文件
- `numts_regions.bed`: 从真实数据转换的NUMTs区域文件
- `*.convert.noGap.tsv`: 转换后的伪参考基因组文件
- `*.enrichmentOutput.*.tsv`: 富集分析结果文件